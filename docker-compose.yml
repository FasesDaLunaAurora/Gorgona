
services:
  # Banco de dados PostgreSQL compartilhado entre todos os microsserviços
  db:
    image: postgres:15
    container_name: gorgona_db
    environment:
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT}:5432"

  # Microsserviço de usuario (usuários e login)
  usuario:
    build: ./backend/microsservice_user  # Caminho do Dockerfile
    container_name: gorgona_user
    ports:
      - "${MICROSSERVICE_USER_PORT}:8000"  # Porta no host, 8000 no container
    env_file:
      - ./backend/microsservice_user/.env  # Injeta variáveis de ambiente
    volumes:
    - ./backend/microsservice_user/src:/app/src  # <- mapeia código
    - ./backend/microsservice_user/alembic.ini:/app/alembic.ini  # <- mapeia alembic.ini
    - ./backend/microsservice_user/alembic:/app/alembic        # pasta de migrations
    depends_on:
      - db                          # Garante que o DB suba primeiro

# Microsserviço de produto
  produto:
    build: ./backend/microsservice_product
    container_name: gorgona_product
    ports:
      - "${MICROSSERVICE_PRODUCT_PORT}:8000"
    env_file:
      - ./backend/microsservice_product/.env
    volumes:
    - ./backend/microsservice_product/src:/app/src
    - ./backend/microsservice_product/alembic.ini:/app/alembic.ini
    - ./backend/microsservice_product/alembic:/app/alembic
    depends_on:
      - db

# Volumes para persistir dados do banco
volumes:
  db_data:
